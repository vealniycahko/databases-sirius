# Используемая база данных

```sql
drop table if exists equipment cascade;
drop table if exists holder cascade;

create table holder
(
    name  text,
    phone text primary key
);

insert into holder (name, phone)
values ('Альберт Андреевич', '0001'),
       ('Иван Вячеславович', '0002'),
       ('Вячеслав Александрович', '0003'),
       ('Алексей Андреевич', '0004');

create table equipment
(
    title        text,
    holder_phone text references holder,
    count        int,
    type         text,
    weight       int,
    price        numeric
);

insert into equipment (title, count, holder_phone, type, weight, price)
values ('Защитный комплект', 8, '0003', 'Фигурное катание', 780, 2300),
       ('Термос', 4, '0001', 'Поход', 240, 670),
       ('Коньки', 7, '0002', 'Фигурное катание', 920, 1990),
       ('Автомат', 4, '0002', 'Страйкбол', 3100, 13900),
       ('Ледоступы (пары)', 6, '0001', 'Альпинизм', 93, 599),
       ('Пистолет', 12, '0001', 'Страйкбол', 370, 2100),
       ('Стропы', 7, '0003', 'Альпинизм', 1800, 9900),
       ('Дождевик', 10, '0002', 'Поход', 140, 1100),
       ('Дротик', 9, '0001', 'Дартс', 8, 65),
       ('Маска защитная', 14, '0001', 'Страйкбол', 550, 1900),
       ('Мяч', 3, '0001', 'Настольный теннис', 3, 70),
       ('Гидрокостюм', 12, '0002', 'Дайвинг', 1500, 4490),
       ('Ледоруб', 8, '0003', 'Альпинизм', 450, 7760),
       ('Сноуборд', 13, '0001', 'Сноубординг', 2560, 5780),
       ('Компенсатор', 11, '0002', 'Дайвинг', 1100, 28000),
       ('Ракетка', 2, '0003', 'Настольный теннис', 200, 1345),
       ('Нагрудник', 13, '0001', 'Страйкбол', 2900, 5560),
       ('Спальник', 5, '0001', 'Поход', 1300, 1790),
       ('Мишень', 1, '0001', 'Дартс', 4630, 3120),
       ('Удочка', 2, '0001', 'Рыбалка', 80, 1500),
       ('Сетка', 1, '0003', 'Настольный теннис', 760, 2450),
       ('Компас', 1, '0003', 'Поход', 50, 180),
       ('Ботинки (пары)', 15, '0003', 'Сноубординг', 980, 8700),
       ('Мангал', 1, '0002', 'Поход', 23000, 7900),
       ('Акваланг', 8, '0003', 'Дайвинг', 9800, 31500),
       ('Палатка', 6, '0003', 'Поход', 2400, 3330),
       ('Маска для плавания', 12, '0001', 'Дайвинг', 575, 1560),
       ('Ласты', 9, '0002', 'Дайвинг', 220, 2950),
       ('Рюкзак', 10, '0002', 'Поход', 1000, 2900);
```

# Фильтрация

```sql
-- вывод экипировки с ценой от 5000 до 20000
select *
from equipment
where price > 5000
  and price < 20000;

-- альтернативный вариант
select *
from equipment
where price between 5000 and 20000;

-- subquery, вывод экипировки владельцев Альберт Андреевич и Иван Вячеславович
select *
from equipment
where holder_phone in (select phone from holder where name = 'Альберт Андреевич' or name = 'Вячеслав Александрович');
```

# Группировка
Для понимания как работает группировка по указанным столбцам проще всего сделать упорядочивание
по этим столбцам. Например по name и type
```sql
select name, type, title, count, weight, price
from holder
         join equipment on phone = holder_phone
order by name, type;
```
Если разделить результат по комбинациям строк name и type получится 18 групп.

| name                   | type              | title              | count | weight | price |
|:-----------------------|:------------------|:-------------------|:------|:-------|:------|
| Альберт Андреевич      | Альпинизм         | Ледоступы \(пары\) | 6     | 93     | 599   |
| Альберт Андреевич      | Дайвинг           | Маска для плавания | 12    | 575    | 1560  |
| Альберт Андреевич      | Дартс             | Мишень             | 1     | 4630   | 3120  |
| Альберт Андреевич      | Дартс             | Дротик             | 9     | 8      | 65    |
| Альберт Андреевич      | Настольный теннис | Мяч                | 3     | 3      | 70    |
| Альберт Андреевич      | Поход             | Спальник           | 5     | 1300   | 1790  |
| Альберт Андреевич      | Поход             | Термос             | 4     | 240    | 670   |
| Альберт Андреевич      | Рыбалка           | Удочка             | 2     | 80     | 1500  |
| Альберт Андреевич      | Сноубординг       | Сноуборд           | 13    | 2560   | 5780  |
| Альберт Андреевич      | Страйкбол         | Маска защитная     | 14    | 550    | 1900  |
| Альберт Андреевич      | Страйкбол         | Пистолет           | 12    | 370    | 2100  |
| Альберт Андреевич      | Страйкбол         | Нагрудник          | 13    | 2900   | 5560  |
| Вячеслав Александрович | Альпинизм         | Ледоруб            | 8     | 450    | 7760  |
| Вячеслав Александрович | Альпинизм         | Стропы             | 7     | 1800   | 9900  |
| Вячеслав Александрович | Дайвинг           | Акваланг           | 8     | 9800   | 31500 |
| Вячеслав Александрович | Настольный теннис | Сетка              | 1     | 760    | 2450  |
| Вячеслав Александрович | Настольный теннис | Ракетка            | 2     | 200    | 1345  |
| Вячеслав Александрович | Поход             | Палатка            | 6     | 2400   | 3330  |
| Вячеслав Александрович | Поход             | Компас             | 1     | 50     | 180   |
| Вячеслав Александрович | Сноубординг       | Ботинки \(пары\)   | 15    | 980    | 8700  |
| Вячеслав Александрович | Фигурное катание  | Защитный комплект  | 8     | 780    | 2300  |
| Иван Вячеславович      | Дайвинг           | Компенсатор        | 11    | 1100   | 28000 |
| Иван Вячеславович      | Дайвинг           | Гидрокостюм        | 12    | 1500   | 4490  |
| Иван Вячеславович      | Дайвинг           | Ласты              | 9     | 220    | 2950  |
| Иван Вячеславович      | Поход             | Дождевик           | 10    | 140    | 1100  |
| Иван Вячеславович      | Поход             | Рюкзак             | 10    | 1000   | 2900  |
| Иван Вячеславович      | Поход             | Мангал             | 1     | 23000  | 7900  |
| Иван Вячеславович      | Страйкбол         | Автомат            | 4     | 3100   | 13900 |
| Иван Вячеславович      | Фигурное катание  | Коньки             | 7     | 920    | 1990  |

При группировке можно выводить поля, по которым происходит группировка, а к остальным полям можно применять агрегатные функции. Например:
```sql
select name,
       type,
       sum(weight * count) as total_weight,
       sum(price * count)  as total_price,
       sum(count)          as total_count
from holder
         join equipment on phone = holder_phone
group by name, type;
```
Результат:

| name                   | type              | total\_weight | total\_price | total\_count |
|:-----------------------|:------------------|:--------------|:-------------|:-------------|
| Альберт Андреевич      | Страйкбол         | 49840         | 124080       | 39           |
| Вячеслав Александрович | Сноубординг       | 14700         | 130500       | 15           |
| Вячеслав Александрович | Дайвинг           | 78400         | 252000       | 8            |
| Иван Вячеславович      | Фигурное катание  | 6440          | 13930        | 7            |
| Альберт Андреевич      | Настольный теннис | 9             | 210          | 3            |
| Альберт Андреевич      | Дартс             | 4702          | 3705         | 10           |
| Альберт Андреевич      | Рыбалка           | 160           | 3000         | 2            |
| Иван Вячеславович      | Страйкбол         | 12400         | 55600        | 4            |
| Вячеслав Александрович | Настольный теннис | 1160          | 5140         | 3            |
| Альберт Андреевич      | Альпинизм         | 558           | 3594         | 6            |
| Иван Вячеславович      | Поход             | 34400         | 47900        | 21           |
| Вячеслав Александрович | Фигурное катание  | 6240          | 18400        | 8            |
| Альберт Андреевич      | Дайвинг           | 6900          | 18720        | 12           |
| Альберт Андреевич      | Сноубординг       | 33280         | 75140        | 13           |
| Иван Вячеславович      | Дайвинг           | 32080         | 388430       | 32           |
| Альберт Андреевич      | Поход             | 7460          | 11630        | 9            |
| Вячеслав Александрович | Поход             | 14450         | 20160        | 7            |
| Вячеслав Александрович | Альпинизм         | 16200         | 131380       | 15           |

Для сгруппированного результата может потребоваться дополнительно применить фильтрацию. Оператор where
для групп применять нельзя, вместо него используется having. Например вывод групп, у которых вес больше 40кг:

```sql
select name,
       type,
       sum(weight * count) as total_weight,
       sum(price * count)  as total_price,
       sum(count)          as total_count
from holder
         join equipment on phone = holder_phone
group by name, type
having sum(weight * count) > 40000;
```
Результат:

| name                   | type      | total\_weight | total\_price | total\_count |
|:-----------------------|:----------|:--------------|:-------------|:-------------|
| Альберт Андреевич      | Страйкбол | 49840         | 124080       | 39           |
| Вячеслав Александрович | Дайвинг   | 78400         | 252000       | 8            |

Альтернативный вариант через Common Table Expression:

```sql
with grouped_by_name_and_type as (
    select name,
           type,
           sum(weight * count) as total_weight,
           sum(price * count)  as total_price,
           sum(count)          as total_count
    from holder
             join equipment on phone = holder_phone
    group by name, type
)
select *
from grouped_by_name_and_type
where total_weight > 40000;
```
Здесь результат группировки сохраняется во временную таблицу, которую можно использовать в рамках
этого запроса. И к этой временной таблице уже можно применять оператор where. Результат такого запроса
аналогичен предыдущему.
