Чтобы свести ручную работу к минимуму можно использовать готовый [docker image](https://hub.docker.com/r/bitnami/postgresql), 
в котором настройки репликации задаются через environment variables.

Для того, чтобы работал `pg_cron` нужно изменить `dockerfile-pg`, теперь он должен выглядеть так:
```dockerfile
FROM bitnami/postgresql:14.5.0

ARG POSTGRES_DB

USER root
RUN apt-get update \
    && apt-get install -y postgresql-common gnupg \
    && echo -ne '\n' | sh /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh \
    && apt-get -y install postgresql-14-cron \
    && cp /usr/lib/postgresql/14/lib/pg_cron.so /opt/bitnami/postgresql/lib \
    && cp /usr/share/postgresql/14/extension/pg_cron* /opt/bitnami/postgresql/share/extension \
    && chmod +x /opt/bitnami/postgresql/lib/pg_cron.so

USER 1001
RUN echo "cron.database_name = '$POSTGRES_DB'" >> /opt/bitnami/postgresql/conf/conf.d/extended.conf
RUN echo "cron.use_background_workers = on" >> /opt/bitnami/postgresql/conf/conf.d/extended.conf
```

Так же нужно изменить сервис postgres в `docker-compose.yml`:
1. секцию user удалить
2. в секцию build добавить
```dockerfile
      args:
        POSTGRES_DB: ${POSTGRES_DB}
```
3. секцию environment изменить на следующую:
```dockerfile
      POSTGRESQL_DATABASE: ${POSTGRES_DB}
      POSTGRESQL_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRESQL_SHARED_PRELOAD_LIBRARIES: "pgaudit,pg_cron"
      POSTGRESQL_REPLICATION_MODE: master
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_password
```
4. в секции healthcheck изменить test:
```dockerfile
      test: ["CMD", "pg_isready", "-U", "postgres"]
```

Должно получиться так:
```yaml
version: "3.8"
services:
  postgres:
    container_name: ${APP_NAME}-postgres
    build:
      context: .
      dockerfile: ./dockerfile-pg
      args:
        POSTGRES_DB: ${POSTGRES_DB}
    environment:
      POSTGRESQL_DATABASE: ${POSTGRES_DB}
      POSTGRESQL_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRESQL_SHARED_PRELOAD_LIBRARIES: "pgaudit,pg_cron"
      POSTGRESQL_REPLICATION_MODE: master
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_password
    ports:
      - "${POSTGRES_PORT}:5432"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 1s
      timeout: 1s
      retries: 30
    restart: unless-stopped
```

После этого нужно создать отдельный docker-compose.yml в отдельной папке для реплики:
```yaml
version: "3.8"

services:
  postgresql-slave:
    image: bitnami/postgresql:14.5.0
    ports:
      - ${SLAVE_PORT}:5432
    environment:
      POSTGRESQL_MASTER_HOST: ${MASTER_HOST}
      POSTGRESQL_PASSWORD: ${MASTER_PASSWORD}
      POSTGRESQL_MASTER_PORT_NUMBER: ${MASTER_PORT}
      POSTGRESQL_REPLICATION_MODE: slave
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_password
    extra_hosts:
      - "host.docker.internal:host-gateway"
```
Пример `.env` для него:
```
SLAVE_PORT=38749

MASTER_PORT=38746
MASTER_HOST=host.docker.internal
MASTER_PASSWORD=my_password
```
